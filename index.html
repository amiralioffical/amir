<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5" />
  <title>دوا لينك - منصة تبادل الأدوية للصيدليات</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root { 
      --primary: #14b8a6; 
      --primary-dark: #0d9488;
      --primary-light: #f0fdfa; 
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    * { -webkit-tap-highlight-color: transparent; }
    body { 
      font-family: 'Cairo', sans-serif; 
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
    }
    .product-card { 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform;
    }
    .product-card:hover { 
      transform: translateY(-8px); 
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    .product-card:active {
      transform: translateY(-2px);
    }
    .spinner { 
      border: 3px solid rgba(20, 184, 166, 0.1); 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      width: 40px; 
      height: 40px; 
      animation: spin 0.8s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-content { 
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 95vh;
    }
    @keyframes slideUp { 
      from { transform: translateY(50px); opacity: 0; } 
      to { transform: translateY(0); opacity: 1; } 
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .whatsapp-btn { 
      position: fixed; 
      bottom: 20px; 
      left: 20px; 
      z-index: 1000;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .whatsapp-btn a { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white; 
      padding: 14px 20px; 
      border-radius: 50px; 
      text-decoration: none; 
      font-weight: 600; 
      box-shadow: 0 8px 16px rgba(37, 211, 102, 0.3);
      transition: all 0.3s ease;
    }
    .whatsapp-btn a:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 12px 24px rgba(37, 211, 102, 0.4);
    }
    @media (max-width: 640px) {
      .whatsapp-btn a {
        padding: 12px 16px;
        font-size: 14px;
      }
      .whatsapp-btn a span {
        display: none;
      }
      .whatsapp-btn a i {
        font-size: 24px;
      }
    }
    .floating-btn {
      position: fixed;
      bottom: 100px;
      left: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 16px rgba(20, 184, 166, 0.3);
      z-index: 999;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .floating-btn:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 12px 24px rgba(20, 184, 166, 0.4);
    }
    .floating-btn:active {
      transform: scale(0.95);
    }
    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    .selected-card {
      position: relative;
      overflow: hidden;
    }
    .selected-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, #10b981 100%);
    }
    .qty-input { 
      width: 70px; 
      text-align: center;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px;
      transition: all 0.2s;
    }
    .qty-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }
    .product-description div { 
      margin-bottom: 0.5rem; 
      padding: 8px 12px; 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      border-radius: 8px; 
      border-right: 4px solid var(--primary);
      font-size: 14px;
      line-height: 1.6;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      max-width: 90%;
      animation: slideInRight 0.3s ease-out;
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(20, 184, 166, 0.3);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .logo-container {
      position: relative;
      width: 56px;
      height: 56px;
    }
    .logo-container::after {
      content: '';
      position: absolute;
      inset: -3px;
      background: linear-gradient(135deg, var(--primary) 0%, #10b981 100%);
      border-radius: 16px;
      z-index: -1;
      opacity: 0.2;
      animation: pulse-ring 2s infinite;
    }
    @keyframes pulse-ring {
      0%, 100% { transform: scale(1); opacity: 0.2; }
      50% { transform: scale(1.1); opacity: 0; }
    }
    @media (max-width: 640px) {
      .modal-content {
        margin: 10px;
        max-height: 92vh;
      }
      .toast {
        min-width: auto;
        right: 10px;
        left: 10px;
      }
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    .empty-state i {
      font-size: 64px;
      color: #cbd5e1;
      margin-bottom: 20px;
      display: inline-block;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .input-group {
      position: relative;
    }
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      transform: translateY(-24px) scale(0.85);
      color: var(--primary);
    }
    .input-group label {
      position: absolute;
      right: 12px;
      top: 12px;
      transition: all 0.2s;
      pointer-events: none;
      background: white;
      padding: 0 4px;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-7xl mx-auto p-3 sm:p-6">
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-gradient-to-br from-teal-50 to-blue-50 z-50 flex items-center justify-center hidden">
      <div class="text-center p-8 bg-white rounded-2xl shadow-2xl max-w-md mx-4 fade-in">
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center">
          <i class="fas fa-pills text-4xl text-white"></i>
        </div>
        <h2 id="auth-title" class="text-2xl font-bold mb-2 text-slate-800">مرحباً بك في دوا لينك</h2>
        <p class="text-slate-500 mb-6">منصة تبادل الأدوية بين الصيدليات</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="login-btn" class="flex-1 bg-gradient-to-r from-teal-500 to-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
            <i class="fas fa-sign-in-alt ml-2"></i> تسجيل الدخول
          </button>
          <button id="register-btn" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
            <i class="fas fa-user-plus ml-2"></i> حساب جديد
          </button>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="glass-effect rounded-2xl shadow-lg p-4 sm:p-6 mb-6 hidden" id="header">
      <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="logo-container w-14 h-14 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white shadow-lg">
            <i class="fas fa-pills text-2xl"></i>
          </div>
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-teal-600 to-teal-800 bg-clip-text text-transparent">دوا لينك</h1>
            <p class="text-sm text-slate-500" id="user-greeting"></p>
          </div>
        </div>
        
        <div class="w-full lg:w-auto flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <div class="relative flex-grow sm:min-w-[300px]">
            <input id="search-input" type="search" placeholder="ابحث عن منتج..." class="w-full rounded-xl pr-12 pl-4 py-3 shadow-sm bg-white border-2 border-slate-200 focus:outline-none focus:border-teal-400 transition-all">
            <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
          </div>
          
          <div class="relative">
            <select id="region-filter" class="w-full sm:w-auto rounded-xl px-4 py-3 shadow-sm bg-white border-2 border-slate-200 focus:outline-none focus:border-teal-400 appearance-none pr-10 cursor-pointer transition-all">
              <option value="">كل المناطق</option>
            </select>
            <i class="fas fa-map-marker-alt absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
          </div>
          
          <button id="logout-btn" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all whitespace-nowrap">
            <i class="fas fa-sign-out-alt ml-2"></i> خروج
          </button>
        </div>
      </div>
    </header>

    <!-- Loading -->
    <div id="loading" class="text-center py-20">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-slate-500 font-semibold">جاري تحميل المنتجات...</p>
    </div>

    <!-- Products Grid -->
    <main id="products-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6"></main>
    
    <div id="loader-sentinel"></div>
    <div id="loading-more" class="text-center py-8 hidden">
      <div class="spinner mx-auto"></div>
    </div>

    <!-- Floating Cart Button -->
    <button id="confirm-order-btn" class="floating-btn hidden" onclick="openConfirmModal()">
      <i class="fas fa-shopping-cart text-xl"></i>
      <span id="cart-badge" class="badge">0</span>
    </button>
  </div>

  <!-- WhatsApp Button -->
  <div class="whatsapp-btn">
    <a href="https://wa.me/201557913163?text=مرحباً، أود عرض صنف دوائي على الموقع" target="_blank">
      <i class="fab fa-whatsapp text-xl"></i>
      <span>عرض دواء</span>
    </a>
  </div>

  <!-- Modals -->
  <div id="disclaimer-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-60 p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-6 text-white">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-2xl font-bold mb-2">شروط الاستخدام</h2>
            <p class="text-teal-50 text-sm">يرجى قراءة الشروط بعناية قبل المتابعة</p>
          </div>
          <button id="close-disclaimer-btn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition-all text-2xl">&times;</button>
        </div>
      </div>
      
      <div class="p-6 max-h-[60vh] overflow-y-auto">
        <div class="bg-amber-50 border-r-4 border-amber-500 p-4 rounded-lg mb-6">
          <div class="flex items-start gap-3">
            <i class="fas fa-exclamation-triangle text-amber-500 text-xl mt-1"></i>
            <div>
              <strong class="text-amber-900 block mb-1">تحذير هام</strong>
              <p class="text-amber-800 text-sm">هذا الموقع مخصص فقط للصيدليات المسجلة. أي استخدام غير مصرح به قد يعرضك للمساءلة القانونية.</p>
            </div>
          </div>
        </div>
        
        <div class="space-y-4 text-slate-700 leading-relaxed text-sm">
          <p><strong>دوا لينك</strong> منصة تهدف لتسهيل التواصل بين الصيدليات المصرية بشأن الأدوية الراكدة.</p>
          
          <div class="bg-slate-50 p-4 rounded-lg">
            <h3 class="font-bold text-slate-800 mb-2">إخلاء المسؤولية:</h3>
            <p>المنصة لا تقوم ببيع أو شراء أي أدوية، ودورها مقتصر على توفير وسيلة اتصال بين الصيدليات. المسؤولية الكاملة تقع على الصيدليات المشاركة.</p>
          </div>
          
          <ul class="space-y-2 mr-4">
            <li class="flex items-start gap-2">
              <i class="fas fa-check-circle text-teal-500 mt-1"></i>
              <span>جميع المنتجات يجب أن تكون مطابقة لمعايير الهيئة العامة للدواء</span>
            </li>
            <li class="flex items-start gap-2">
              <i class="fas fa-check-circle text-teal-500 mt-1"></i>
              <span>يجب التحقق من صلاحية وجودة الأدوية قبل أي تعامل</span>
            </li>
            <li class="flex items-start gap-2">
              <i class="fas fa-check-circle text-teal-500 mt-1"></i>
              <span>المنصة غير مسؤولة عن الاتفاقيات التجارية بين الأطراف</span>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="p-6 bg-slate-50 border-t">
        <button id="accept-disclaimer-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-xl transition-all">
          <i class="fas fa-check ml-2"></i> أوافق على الشروط
        </button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-60 p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
      <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 id="modal-title" class="text-2xl font-bold">تسجيل جديد</h2>
          <button id="close-auth-btn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition-all text-2xl">&times;</button>
        </div>
      </div>
      
      <div class="p-6 max-h-[60vh] overflow-y-auto">
        <form id="auth-form">
          <input type="hidden" id="auth-type" value="register">
          
          <div id="register-fields" class="space-y-4">
            <div>
              <label class="block text-slate-700 font-semibold mb-2">اسم الصيدلية</label>
              <input type="text" id="pharmacy-name" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="أدخل اسم الصيدلية">
            </div>
            <div>
              <label class="block text-slate-700 font-semibold mb-2">رقم الهاتف (واتساب)</label>
              <input type="tel" id="phone" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="01xxxxxxxxx">
            </div>
            <div>
              <label class="block text-slate-700 font-semibold mb-2">كلمة السر</label>
              <input type="password" id="password" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="••••••••">
            </div>
            <div>
              <label class="block text-slate-700 font-semibold mb-2">تأكيد كلمة السر</label>
              <input type="password" id="confirm-password" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="••••••••">
            </div>
            <div>
              <label class="block text-slate-700 font-semibold mb-2">عنوان الصيدلية</label>
              <textarea id="address" rows="2" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all resize-none" placeholder="العنوان بالتفصيل"></textarea>
            </div>
          </div>
          
          <div id="login-fields" class="space-y-4 hidden">
            <div>
              <label class="block text-slate-700 font-semibold mb-2">رقم الهاتف</label>
              <input type="tel" id="phone-login" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="01xxxxxxxxx">
            </div>
            <div>
              <label class="block text-slate-700 font-semibold mb-2">كلمة السر</label>
              <input type="password" id="password-login" class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-teal-400 focus:outline-none transition-all" placeholder="••••••••">
            </div>
          </div>
        </form>
      </div>
      
      <div class="p-6 bg-slate-50 border-t">
        <button id="submit-auth-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-xl transition-all">
          تسجيل
        </button>
        <div id="auth-status" class="text-center mt-3"></div>
        <p class="text-center text-sm text-slate-500 mt-4">
          <a href="#" id="switch-auth" class="text-teal-600 hover:text-teal-700 font-semibold">لديك حساب؟ قم بالدخول</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Confirm Order Modal -->
  <div id="confirm-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-60 p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
      <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-6 text-white">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold">تأكيد الطلب</h2>
          <button id="close-confirm-btn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-10 h-10 flex items-center justify-center transition-all text-2xl">&times;</button>
        </div>
      </div>
      
      <div class="p-6 max-h-[60vh] overflow-y-auto">
        <div id="confirm-order-details" class="space-y-3"></div>
        <div id="confirm-user-details" class="mt-6 p-4 bg-slate-50 rounded-xl"></div>
      </div>
      
      <div class="p-6 bg-slate-50 border-t">
        <button id="submit-confirm-btn" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-xl transition-all">
          <i class="fas fa-paper-plane ml-2"></i> إرسال الطلب
        </button>
        <div id="confirm-status" class="text-center mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Success Overlay -->
  <div id="success-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-70">
    <div class="text-center text-white fade-in">
      <div class="bg-green-500 w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl">
        <i class="fas fa-check text-6xl"></i>
      </div>
      <h2 class="text-4xl font-bold mb-3">تم التأكيد بنجاح!</h2>
      <p class="text-xl text-green-100">سيتم التواصل معك قريباً</p>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw2liABztwCljtmT8zCsu7IFjdolk5XT4Fp5BzpN2H_wBReCto-jTJ1m6ilpS1PFnsEQg/exec";
    let allProducts = [];
    let filteredProducts = [];
    let displayedProducts = [];
    let fuse = null;
    let intersectionObserver;
    let isFiltering = false;
    let selectedProducts = [];
    const ITEMS_PER_PAGE = 20;
    let currentUser = JSON.parse(localStorage.getItem('dawaUser') || 'null');
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle'
      };
      const toast = document.createElement('div');
      toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-centergap-3`;
      toast.innerHTML = `
        <i class="fas ${icons[type]} text-xl"></i>
        <span class="font-semibold">${message}</span>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function updateSelectedCount() {
      const count = selectedProducts.length;
      $('#cart-badge').textContent = count;
      const btn = $('#confirm-order-btn');
      if (count > 0) {
        btn.classList.remove('hidden');
      } else {
        btn.classList.add('hidden');
      }
    }

    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
    }

    function closeConfirmModal() {
      $('#confirm-modal').classList.add('hidden');
      $('#confirm-modal').classList.remove('flex');
      $('#confirm-status').innerHTML = '';
    }

    function openConfirmModal() {
      if (selectedProducts.length === 0) return;
      let detailsHtml = '';
      selectedProducts.forEach((p, index) => {
        detailsHtml += `
          <div class="bg-white border-2 border-slate-200 rounded-xl p-4 hover:border-teal-300 transition-all">
            <h4 class="font-bold text-slate-800 mb-2">${escapeHtml(p.name)}</h4>
            <div class="flex justify-between items-center text-sm text-slate-600 mb-3">
              <span>السعر: <strong class="text-teal-600">${p.publicPrice.toFixed(2)} ج.م</strong></span>
              <span>الخصم: <strong class="text-red-500">${p.discount}%</strong></span>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm font-semibold text-slate-700">الكمية:</label>
              <input type="number" min="1" max="${p.quantity}" value="${p.requestedQty}" data-index="${index}" class="qty-input flex-1">
              <span class="text-xs text-slate-500">من ${p.quantity}</span>
            </div>
          </div>
        `;
      });
      $('#confirm-order-details').innerHTML = detailsHtml;
      
      $$('.qty-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          const newQty = parseInt(e.target.value);
          if (newQty > selectedProducts[index].quantity) {
            showToast('الكمية أكبر من المتاحة', 'error');
            e.target.value = selectedProducts[index].requestedQty;
            return;
          }
          selectedProducts[index].requestedQty = newQty;
        });
      });

      $('#confirm-user-details').innerHTML = `
        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
          <i class="fas fa-store text-teal-600"></i>
          بيانات الصيدلية
        </h4>
        <div class="space-y-2 text-sm">
          <p><strong>الاسم:</strong> ${escapeHtml(currentUser.pharmacyName)}</p>
          <p><strong>الهاتف:</strong> ${escapeHtml(currentUser.phone)}</p>
          <p><strong>العنوان:</strong> ${escapeHtml(currentUser.address)}</p>
        </div>
      `;
      
      $('#confirm-modal').classList.remove('hidden');
      $('#confirm-modal').classList.add('flex');
    }

    function logout(reason = '') {
      localStorage.removeItem('dawaUser');
      currentUser = null;
      selectedProducts = [];
      updateSelectedCount();
      $('#header').classList.add('hidden');
      $('#auth-overlay').classList.remove('hidden');
      if (reason) showToast(reason, 'error');
    }

    function initApp() {
      if (currentUser) {
        if (currentUser.status !== 'approved') {
          logout(currentUser.status === 'blocked' ? 'حسابك محظور' : 'طلبك قيد الموافقة');
          return;
        }
        $('#user-greeting').textContent = `مرحباً، ${currentUser.pharmacyName}`;
        $('#header').classList.remove('hidden');
        $('#auth-overlay').classList.add('hidden');
        fetchProducts();
      } else {
        $('#header').classList.add('hidden');
        $('#auth-overlay').classList.remove('hidden');
      }
    }

    function closeAuthModal() {
      $('#auth-modal').classList.add('hidden');
      $('#auth-modal').classList.remove('flex');
      $('#auth-form').reset();
      $('#auth-status').innerHTML = '';
    }

    async function submitAuth() {
      const type = $('#auth-type').value;
      let isValid = true;
      
      if (type === 'register') {
        if (!$('#pharmacy-name').value.trim()) { isValid = false; showToast('اسم الصيدلية مطلوب', 'error'); }
        if (!$('#phone').value.trim()) { isValid = false; showToast('رقم الهاتف مطلوب', 'error'); }
        if (!$('#password').value.trim()) { isValid = false; showToast('كلمة السر مطلوبة', 'error'); }
        if ($('#password').value !== $('#confirm-password').value) { isValid = false; showToast('كلمة السر غير متطابقة', 'error'); }
        if (!$('#address').value.trim()) { isValid = false; showToast('العنوان مطلوب', 'error'); }
      } else {
        if (!$('#phone-login').value.trim()) { isValid = false; showToast('رقم الهاتف مطلوب', 'error'); }
        if (!$('#password-login').value.trim()) { isValid = false; showToast('كلمة السر مطلوبة', 'error'); }
      }
      
      if (!isValid) return;

      const btn = $('#submit-auth-btn');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner mx-auto w-6 h-6 border-2"></div>';

      const passwordHash = CryptoJS.MD5(type === 'register' ? $('#password').value : $('#password-login').value).toString();
      const phone = type === 'register' ? $('#phone').value : $('#phone-login').value;
      
      const formData = new FormData();
      formData.append('action', type);
      formData.append('phone', phone);
      formData.append('passwordHash', passwordHash);
      
      if (type === 'register') {
        formData.append('pharmacyName', $('#pharmacy-name').value);
        formData.append('address', $('#address').value);
      }

      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await res.json();
        
        if (result.success) {
          if (type === 'register') {
            showToast('تم إرسال طلب التسجيل، انتظر الموافقة', 'success');
            closeAuthModal();
          } else {
            currentUser = {
              userId: result.userId,
              pharmacyName: result.pharmacyName,
              phone,
              address: result.address,
              status: result.status
            };
            localStorage.setItem('dawaUser', JSON.stringify(currentUser));
            showToast('تم تسجيل الدخول بنجاح', 'success');
            closeAuthModal();
            initApp();
          }
        } else {
          throw new Error(result.error || 'فشل العملية');
        }
      } catch (err) {
        $('#auth-status').innerHTML = `<p class="text-red-500 text-sm flex items-center gap-2"><i class="fas fa-exclamation-circle"></i>${escapeHtml(err.message)}</p>`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function openAuthModal(type) {
      $('#auth-type').value = type;
      $('#modal-title').textContent = type === 'register' ? 'تسجيل جديد' : 'تسجيل الدخول';
      $('#submit-auth-btn').textContent = type === 'register' ? 'تسجيل' : 'دخول';
      $('#switch-auth').textContent = type === 'register' ? 'لديك حساب؟ قم بالدخول' : 'حساب جديد؟ سجل الآن';
      
      $('#register-fields').classList.toggle('hidden', type !== 'register');
      $('#login-fields').classList.toggle('hidden', type !== 'login');
      
      $('#auth-modal').classList.remove('hidden');
      $('#auth-modal').classList.add('flex');
    }

    async function submitOrder() {
      if (!currentUser || currentUser.status !== 'approved') {
        showToast('يجب تسجيل الدخول أولاً', 'error');
        return;
      }

      const btn = $('#submit-confirm-btn');
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner mx-auto w-6 h-6 border-2"></div>';

      const orderData = selectedProducts.map(p => ({
        id: p.id,
        name: p.name,
        price: parseFloat(p.publicPrice) || 0,
        discount: p.discount || 0,
        quantity: p.requestedQty || 1
      }));

      const formData = new FormData();
      formData.append('action', 'purchase');
      formData.append('order', JSON.stringify(orderData));
      formData.append('userId', currentUser.userId);
      formData.append('pharmacyName', currentUser.pharmacyName);
      formData.append('pharmacyPhone', currentUser.phone);
      formData.append('pharmacyAddress', currentUser.address);

      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const result = await res.json();
        
        if (result.success) {
          closeConfirmModal();
          $('#success-overlay').classList.remove('hidden');
          $('#success-overlay').classList.add('flex');
          
          setTimeout(() => {
            $('#success-overlay').classList.add('hidden');
            $('#success-overlay').classList.remove('flex');
          }, 3000);
          
          orderData.forEach(od => {
            const product = allProducts.find(p => p.id === od.id);
            if (product) product.quantity -= od.quantity;
          });
          
          selectedProducts = [];
          updateSelectedCount();
          applyFilters();
          showToast('تم إرسال الطلب بنجاح', 'success');
        } else {
          throw new Error(result.error || 'فشل إرسال الطلب');
        }
      } catch (err) {
        $('#confirm-status').innerHTML = `<p class="text-red-500 text-sm flex items-center gap-2"><i class="fas fa-exclamation-circle"></i>${escapeHtml(err.message)}</p>`;
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function renderProducts(products, append = false) {
      const grid = $('#products-grid');
      if (!append) grid.innerHTML = '';

      if (products.length === 0 && !append) {
        grid.innerHTML = `
          <div class="col-span-full empty-state">
            <i class="fas fa-search"></i>
            <p class="text-slate-500 text-lg font-semibold">لا توجد منتجات تطابق بحثك</p>
            <p class="text-slate-400 text-sm mt-2">جرب كلمات بحث مختلفة</p>
          </div>
        `;
        return;
      }

      const fragment = document.createDocumentFragment();
      products.forEach(p => {
        const isSelected = selectedProducts.some(sp => sp.id === p.id);
        const disabled = p.quantity <= 0;
        
        const card = document.createElement('div');
        card.className = `product-card bg-white rounded-2xl shadow-lg border-2 border-slate-100 p-5 flex flex-col ${disabled ? 'opacity-50 pointer-events-none' : ''} ${isSelected ? 'selected-card border-teal-400' : ''}`;
        
        const imgHtml = p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}" class="w-full h-40 object-cover rounded-xl mb-4 shadow-sm">` : '';
        
        let titleLines = (p.name || '').split('+').map(line => line.trim()).filter(Boolean);
        let titleHTML = titleLines.map(line => `<div class="leading-snug">${escapeHtml(line)}</div>`).join('');
        
        let descriptionHTML = '';
        if (p.description && typeof p.description === 'string') {
          const descLines = p.description.split(/\n+/).map(line => line.trim()).filter(Boolean);
          if (descLines.length > 0) {
            descriptionHTML = `<div class="product-description mt-3">${descLines.map(line => `<div>${escapeHtml(line)}</div>`).join('')}</div>`;
          }
        }

        card.innerHTML = `
          ${imgHtml}
          <div class="flex-grow">
            <h3 class="font-bold text-lg text-slate-800 mb-2">${titleHTML}</h3>
            ${descriptionHTML}
          </div>
          <div class="mt-4 pt-4 border-t-2 border-slate-100">
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div class="bg-teal-50 rounded-lg p-3">
                <div class="text-xs text-teal-600 font-semibold mb-1">سعر الجمهور</div>
                <div class="font-bold text-xl text-teal-700">${p.publicPrice.toFixed(2)} <span class="text-sm">ج.م</span></div>
              </div>
              <div class="bg-red-50 rounded-lg p-3">
                <div class="text-xs text-red-600 font-semibold mb-1">خصم الصيدلي</div>
                <div class="font-bold text-xl text-red-600">${p.discount}<span class="text-sm">%</span></div>
              </div>
            </div>
            <div class="flex items-center justify-between text-sm text-slate-500 mb-3">
              <span><i class="fas fa-box text-teal-500 ml-1"></i> متاح: <strong>${p.quantity}</strong></span>
            </div>
            <div class="flex items-center gap-2 mb-3">
              <label class="text-sm font-semibold text-slate-700 whitespace-nowrap">الكمية:</label>
              <input type="number" min="1" max="${p.quantity}" value="1" class="qty-input flex-1" data-product-id="${p.id}">
            </div>
            <button data-id="${p.id}" class="add-to-order-btn w-full ${isSelected ? 'bg-gradient-to-r from-green-500 to-green-600' : 'bg-gradient-to-r from-slate-700 to-slate-900'} text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">
              <i class="fas ${isSelected ? 'fa-check' : 'fa-cart-plus'} ml-2"></i>
              ${isSelected ? 'تم الإضافة' : 'أضف للطلب'}
            </button>
          </div>
        `;
        fragment.appendChild(card);
      });
      grid.appendChild(fragment);
    }

    function loadMoreProducts() {
      const sourceList = isFiltering ? filteredProducts : allProducts;
      const currentCount = displayedProducts.length;
      
      if (currentCount >= sourceList.length) {
        if (intersectionObserver) intersectionObserver.disconnect();
        $('#loader-sentinel').classList.add('hidden');
        return;
      }

      const nextProducts = sourceList.slice(currentCount, currentCount + ITEMS_PER_PAGE);
      if (nextProducts.length > 0) {
        $('#loading-more').classList.remove('hidden');
        setTimeout(() => {
          displayedProducts.push(...nextProducts);
          renderProducts(nextProducts, true);
          $('#loading-more').classList.add('hidden');
          
          if (displayedProducts.length >= sourceList.length) {
            if (intersectionObserver) intersectionObserver.disconnect();
            $('#loader-sentinel').classList.add('hidden');
          }
        }, 300);
      }
    }

    function setupIntersectionObserver() {
      if (intersectionObserver) intersectionObserver.disconnect();
      
      intersectionObserver = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) loadMoreProducts();
      }, { root: null, rootMargin: '0px', threshold: 0.1 });
    }

    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function applyFilters() {
      const searchTerm = $('#search-input').value.trim();
      const region = $('#region-filter').value;
      
      isFiltering = !!(searchTerm || region);

      if (isFiltering) {
        let sourceList = allProducts;
        if (searchTerm) {
          sourceList = fuse.search(searchTerm).map(r => r.item);
        }
        if (region) {
          sourceList = sourceList.filter(p => p.region === region);
        }
        filteredProducts = sourceList;
      } else {
        filteredProducts = [];
      }

      resetAndRenderFirstPage();
    }

    function resetAndRenderFirstPage() {
      const sourceList = isFiltering ? filteredProducts : allProducts;
      displayedProducts = sourceList.slice(0, ITEMS_PER_PAGE);
      renderProducts(displayedProducts, false);

      if (sourceList.length > ITEMS_PER_PAGE) {
        $('#loader-sentinel').classList.remove('hidden');
        if (intersectionObserver) intersectionObserver.observe($('#loader-sentinel'));
      } else {
        if (intersectionObserver) intersectionObserver.disconnect();
        $('#loader-sentinel').classList.add('hidden');
      }
    }

    async function fetchProducts() {
      $('#loading').style.display = 'block';
      $('#products-grid').classList.add('hidden');
      
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getProducts`);
        const data = await res.json();
        allProducts = Array.isArray(data) ? data : [];
        
        fuse = new Fuse(allProducts, { 
          keys: ['name', 'description'], 
          threshold: 0.4, 
          ignoreLocation: true 
        });

        const regions = [...new Set(allProducts.map(p => p.region).filter(Boolean))].sort();
        const regionFilter = $('#region-filter');
        regionFilter.innerHTML = '<option value="">كل المناطق</option>';
        regions.forEach(r => {
          const option = document.createElement('option');
          option.value = r;
          option.textContent = r;
          regionFilter.appendChild(option);
        });

        setupIntersectionObserver();
        resetAndRenderFirstPage();
        $('#products-grid').classList.remove('hidden');
      } catch (err) {
        showToast(`حدث خطأ أثناء تحميل المنتجات: ${err.message}`, 'error');
      } finally {
        $('#loading').style.display = 'none';
      }
    }

    function shouldShowDisclaimer() {
      const lastShown = localStorage.getItem('disclaimerLastShown');
      const today = new Date().toDateString();
      return lastShown !== today;
    }

    function showDisclaimerModal() {
      $('#disclaimer-modal').classList.remove('hidden');
      $('#disclaimer-modal').classList.add('flex');
    }

    function closeDisclaimerModal() {
      $('#disclaimer-modal').classList.add('hidden');
      $('#disclaimer-modal').classList.remove('flex');
      localStorage.setItem('disclaimerLastShown', new Date().toDateString());
    }

    function setupEventListeners() {
      $('#products-grid').addEventListener('click', e => {
        const btn = e.target.closest('.add-to-order-btn');
        if (btn) {
          const productId = parseInt(btn.dataset.id);
          const product = allProducts.find(p => p.id === productId);
          
          if (product) {
            const card = btn.closest('.product-card');
            const qtyInput = card.querySelector('.qty-input');
            const requestedQty = parseInt(qtyInput.value) || 1;
            
            if (requestedQty > product.quantity) {
              showToast('الكمية المطلوبة أكبر من المتاحة', 'error');
              return;
            }

            const index = selectedProducts.findIndex(sp => sp.id === productId);
            if (index > -1) {
              selectedProducts.splice(index, 1);
            } else {
              selectedProducts.push({ ...product, requestedQty });
            }
            
            updateSelectedCount();
            applyFilters();
          }
        }
      });

      $('#register-btn').addEventListener('click', () => openAuthModal('register'));
      $('#login-btn').addEventListener('click', () => openAuthModal('login'));
      $('#switch-auth').addEventListener('click', (e) => {
        e.preventDefault();
        openAuthModal($('#auth-type').value === 'register' ? 'login' : 'register');
      });
      $('#close-auth-btn').addEventListener('click', closeAuthModal);
      $('#submit-auth-btn').addEventListener('click', submitAuth);
      $('#auth-modal').addEventListener('click', e => {
        if (e.target.id === 'auth-modal') closeAuthModal();
      });

      $('#close-confirm-btn').addEventListener('click', closeConfirmModal);
      $('#confirm-modal').addEventListener('click', e => {
        if (e.target.id === 'confirm-modal') closeConfirmModal();
      });
      $('#submit-confirm-btn').addEventListener('click', submitOrder);

      $('#logout-btn').addEventListener('click', () => logout());

      $('#accept-disclaimer-btn').addEventListener('click', closeDisclaimerModal);
      $('#close-disclaimer-btn').addEventListener('click', closeDisclaimerModal);
      $('#disclaimer-modal').addEventListener('click', e => {
        if (e.target.id === 'disclaimer-modal') closeDisclaimerModal();
      });

      const debouncedSearch = debounce(() => applyFilters(), 300);
      $('#search-input').addEventListener('input', debouncedSearch);
      $('#region-filter').addEventListener('change', () => applyFilters());
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (shouldShowDisclaimer()) showDisclaimerModal();
      initApp();
      setupEventListeners();
    });
  </script>
</body>
</html>
